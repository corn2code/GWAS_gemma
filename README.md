# GWAS SLURM Job Script

This script is designed to run a Genome-Wide Association Study (GWAS) using GEMMA. It utilizes a SLURM job array to efficiently process multiple phenotypes in parallel.

---

## SLURM Job Parameters

```sh
#!/bin/sh
#SBATCH --array=1-10%10                   # Job array to run 10 tasks with a maximum of 10 concurrent jobs
#SBATCH --ntasks=2                         # Number of tasks (processes) to allocate
#SBATCH --mem-per-cpu=40G                  # Memory allocated per CPU
#SBATCH --job-name=GWAS                    # Job name for tracking purposes
#SBATCH --time=25:00:00                    # Maximum time allocated for the job
#SBATCH --partition=jclarke,batch,guest    # Partitions to submit the job to
#SBATCH --output=output.log/%x_%a.out      # Standard output file name pattern (%x: job name, %a: array index)
#SBATCH --mail-type=ALL                    # Send email notifications for job start, end, and fail events
#SBATCH --mail-user=jtorres-rodriguez2@unl.edu # Email for job notifications
```

## Script Functionality

### 1. Clean the Running Environment

```sh
module purge
```

**Description**: Ensures a clean running environment by unloading all currently loaded modules. This prevents any conflicts with previously loaded software.

### 2. Get the Current Job Array Index

```sh
i=${SLURM_ARRAY_TASK_ID}
echo ${i}
```

**Description**: Retrieves the current task index from the SLURM job array and stores it in the variable `i`. It also prints the task index to the output for logging purposes.

### 3. Retrieve the Corresponding Phenotype

```sh
a=$(sed -n ${i}p phenotypes.txt)
echo ${a}
```

**Description**: Uses `sed` to extract the phenotype corresponding to the current task index from the `phenotypes.txt` file. The selected phenotype is stored in variable `a` and printed for logging.

### 4. Load GEMMA Module

```sh
ml gemma/0.98
```

**Description**: Loads the GEMMA module version 0.98, which is required for the GWAS analysis.

### 5. Copy VCF Files to Scratch Directory

```sh
cp WiDiv693.MAF05.vcf.* /scratch/
```

**Description**: Copies all files related to the filtered VCF dataset (`WiDiv693.MAF05.vcf.*`) to the scratch directory for faster I/O operations.

### 6. Run GEMMA for GWAS Analysis

```sh
gemma --bfile /scratch/WiDiv693.MAF05.vcf \
 -p pheno_693_values.GWAS.txt \
 -k ./output/WiDiv693.MAF05.kin.vcf.cXX.txt \
 -c WiDiv693.MAF05.3.pca.txt \
 -n ${i} -lmm 4 \
 -o ${a} \
 -outdir results_NE2020 \
```

**Description**: Runs the GEMMA software to perform GWAS. The parameters include:
- `--bfile`: Path to the input binary PLINK files.
- `-p`: Path to the phenotype file for the GWAS.
- `-k`: Path to the kinship matrix file.
- `-c`: Path to the PCA results file.
- `-n`: Task index for the job array.
- `-lmm 4`: Specifies the linear mixed model type for the analysis.
- `-o`: Output prefix for results, based on the current phenotype.
- `-outdir`: Directory where results will be saved.

### 7. Compress the Association Results

```sh
gzip results_NE2020/${a}.assoc.txt
```

**Description**: Compresses the association results file generated by GEMMA for the current phenotype to save space and facilitate easier storage and transfer.

---

## Notes

- Make sure `phenotypes.txt`, `pheno_693_values.GWAS.txt`, and the required VCF files are properly formatted and located in the working directory before running the script.
- Adjust SLURM parameters as needed based on system and project requirements.# GWAS_gemma
